<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>QR Time Punch</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/html5-qrcode/minified/html5-qrcode.min.js"></script>
</head>
<body class="bg-gray-100">
  <div class="max-w-xl mx-auto p-4">
    <h1 class="text-2xl font-bold mb-4">QR Time Punch</h1>

    <!-- Department -->
    <div class="mb-3">
      <label class="block text-sm font-medium">Department</label>
      <select id="department" class="w-full border p-2 rounded"></select>
    </div>

    <!-- Location -->
    <div class="mb-3">
      <label class="block text-sm font-medium">Location</label>
      <select id="location" class="w-full border p-2 rounded"></select>
    </div>

    <!-- M Number -->
    <div class="mb-3">
      <label class="block text-sm font-medium">M Number (optional)</label>
      <input id="mnumber" placeholder="Enter M Number" class="border p-2 w-full rounded"/>
    </div>

    <!-- Scanner -->
    <button id="startBtn" class="bg-blue-600 text-white px-4 py-2 rounded">Start Scanner</button>
    <button id="stopBtn" class="bg-gray-500 text-white px-4 py-2 rounded ml-2">Stop Scanner</button>

    <div id="reader" class="mt-4 border rounded bg-white" style="width:300px;height:300px;"></div>
    <div id="status" class="mt-4 text-sm"></div>
  </div>

  <script>
  const $ = (id) => document.getElementById(id);
  const API = (path) => path; // relative calls to FastAPI

  async function loadOptions() {
    try {
      const depts = await fetch(API('/api/departments')).then(r=>r.json());
      const locs = await fetch(API('/api/locations')).then(r=>r.json());
      $('department').innerHTML = depts.map(d=>`<option value="${d.id}">${d.name}</option>`).join('');
      $('location').innerHTML = locs.map(l=>`<option value="${l.id}">${l.name}</option>`).join('');
    } catch (err) {
      $('status').innerHTML = "⚠️ Failed to load departments/locations";
    }
  }

  function show(msg, ok=true) {
    $('status').innerHTML = `<div class="p-2 rounded ${ok?'bg-green-100 text-green-800':'bg-red-100 text-red-800'}">${msg}</div>`;
  }

  async function postPunch(qrValue){
    const payload = {
      qr_code_value: qrValue,
      action: "in",
      m_number: $('mnumber').value || null,
      location_id: parseInt($('location').value),
      department_id: parseInt($('department').value),
      device_label: navigator.userAgent
    };
    const res = await fetch(API('/api/punch'), {
      method: 'POST',
      headers: { 'Content-Type':'application/json' },
      body: JSON.stringify(payload)
    });
    if(!res.ok){ throw new Error((await res.json()).detail || 'Punch failed'); }
    return res.json();
  }

  let qr;
  $('startBtn').onclick = async () => {
    if(qr){ await qr.stop().catch(()=>{}); }
    qr = new Html5Qrcode("reader");
    qr.start(
      { facingMode: "environment" }, 
      { fps: 10, qrbox: 250 },
      async (decodedText) => {
        try {
          const r = await postPunch(decodedText.trim());

          // ✅ Stop scanner after first success
          await qr.stop();

          show(`✅ ${r.employee}: ${r.action.toUpperCase()} at ${new Date(r.ts).toLocaleString()}`);
        } catch (err) {
          show("❌ " + err.message, false);
        }
      },
      (err) => {}
    ).catch(e=>show("Camera start failed: " + e, false));
  };

  $('stopBtn').onclick = async () => {
    if(qr){ await qr.stop().catch(()=>{}); show("⏹️ Scanner stopped", false); }
  };

  loadOptions();
</script>

</body>
</html>
