<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HAL9000 QR Time Punch</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/html5-qrcode/minified/html5-qrcode.min.js"></script>
  <style>
    body {
      background: radial-gradient(circle at center, #111 0%, #000 100%);
      font-family: 'Orbitron', sans-serif;
      color: #eee;
    }
    .hal-eye {
      width: 220px;
      height: 220px;
      border-radius: 50%;
      background: radial-gradient(circle at center, red 0%, darkred 60%, #111 100%);
      box-shadow: 0 0 40px rgba(255,0,0,0.8), inset 0 0 20px rgba(255,150,150,0.5);
      animation: pulse 3s infinite;
    }
    @keyframes pulse {
      0%,100% { box-shadow: 0 0 40px rgba(255,0,0,0.8), inset 0 0 20px rgba(255,150,150,0.5); }
      50% { box-shadow: 0 0 80px rgba(255,0,0,1), inset 0 0 30px rgba(255,150,150,0.8); }
    }
    .neon-btn {
      background: transparent;
      border: 2px solid #0ff;
      color: #0ff;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      text-transform: uppercase;
      font-weight: bold;
      transition: 0.2s;
    }
    .neon-btn:hover {
      background: #0ff;
      color: #000;
      box-shadow: 0 0 15px #0ff;
    }
    #status div {
      font-size: 1.2rem;
      margin-top: 1rem;
      text-shadow: 0 0 10px currentColor;
    }
  </style>
</head>
<body class="flex items-center justify-center min-h-screen">
  <div class="flex flex-col items-center text-center space-y-6">
    <h1 class="text-3xl font-bold tracking-widest">OPTIMIL QR TIME PUNCH</h1>

    <!-- HAL Eye -->
    <div class="hal-eye relative flex items-center justify-center">
      <div id="reader" class="absolute w-48 h-48 opacity-0"></div>
    </div>

    <!-- Status -->
    <div id="status" class="text-lg"></div>

    <!-- Controls -->
    <div class="flex space-x-4">
      <button id="startBtn" class="neon-btn">‚ñ∂ Start</button>
      <button id="stopBtn" class="neon-btn">‚èπ Stop</button>
    </div>

    <!-- Punch Type -->
    <div>
      <label class="block mb-1">Punch Type</label>
      <select id="action" class="bg-black border border-gray-600 p-2 rounded text-cyan-400">
        <option value="in">IN</option>
        <option value="out">OUT</option>
        <option value="break_in">BREAK IN</option>
        <option value="break_out">BREAK OUT</option>
      </select>
    </div>

    <!-- HR Export -->
    <button id="exportBtn" class="neon-btn mt-4">üìä Download Report</button>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);
    const API = (path) => path; // relative to FastAPI

    function show(msg, ok=true) {
      $('status').innerHTML = `<div style="color:${ok?'#0f0':'#f00'}">${msg}</div>`;
    }

    async function postPunch(qrValue){
      const payload = {
        qr_code_value: qrValue,
        action: $('action').value,
        device_label: navigator.userAgent
      };
      const res = await fetch(API('/api/punch'), {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify(payload)
      });
      if(!res.ok){ throw new Error((await res.json()).detail || 'Punch failed'); }
      return res.json();
    }

    let qr;
    $('startBtn').onclick = async () => {
      if(qr){ try { await qr.stop(); } catch (e) {} }
      qr = new Html5Qrcode("reader");
      Html5Qrcode.getCameras().then(cameras => {
        if (cameras.length) {
          let cameraId = cameras[cameras.length - 1].id;
          for (let cam of cameras) {
            if (cam.label.toLowerCase().includes("back") || cam.label.toLowerCase().includes("wide")) {
              cameraId = cam.id;
              break;
            }
          }
          qr.start(
            { deviceId: { exact: cameraId } },
            { fps: 20, qrbox: { width: 200, height: 200 } },
            async (decodedText) => {
              try {
                if (qr) { try { await qr.stop(); } catch (e) {} }
                const r = await postPunch(decodedText.trim());
                if (navigator.vibrate) navigator.vibrate(200);
                show(`‚úÖ ${r.employee}: ${r.action.toUpperCase()}`, true);
              } catch (err) {
                show("‚ùå " + err.message, false);
              }
            }
          ).catch(e=>show("Camera start failed: " + e, false));
        } else {
          show("‚ùå No cameras found", false);
        }
      });
    };

    $('stopBtn').onclick = async () => {
      if(qr){
        try { await qr.stop(); show("‚èπÔ∏è Scanner stopped", false); }
        catch (e) { show("‚ö†Ô∏è Scanner already stopped", false); }
      }
    };

    $('exportBtn').onclick = () => { window.location.href = API('/api/export'); };
  </script>
</body>
</html>
