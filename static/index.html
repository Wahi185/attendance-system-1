<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>QR Time Punch</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/html5-qrcode/minified/html5-qrcode.min.js"></script>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center">
  <div class="bg-white shadow-lg rounded-xl p-6 w-full max-w-lg">
    <h1 class="text-2xl font-bold mb-6 text-center">QR Time Punch</h1>

    <!-- Department -->
    <div class="mb-4">
      <label class="block text-sm font-medium mb-1">Department</label>
      <select id="department" class="w-full border p-2 rounded"></select>
    </div>

    <!-- Location -->
    <div class="mb-4">
      <label class="block text-sm font-medium mb-1">Location</label>
      <select id="location" class="w-full border p-2 rounded"></select>
    </div>

    <!-- M Number -->
    <div class="mb-4">
      <label class="block text-sm font-medium mb-1">M Number (optional)</label>
      <input id="mnumber" placeholder="Enter M Number" class="border p-2 w-full rounded"/>
    </div>

    <!-- Punch Type -->
    <div class="mb-4">
      <label class="block text-sm font-medium mb-1">Punch Type</label>
      <select id="action" class="w-full border p-2 rounded">
        <option value="in">IN</option>
        <option value="out">OUT</option>
        <option value="break">BREAK</option>
      </select>
    </div>

    <!-- Scanner Controls -->
    <div class="flex flex-col sm:flex-row gap-2 mb-4">
      <button id="startBtn" class="flex-1 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Start Scanner</button>
      <button id="stopBtn" class="flex-1 bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">Stop Scanner</button>
    </div>

    <!-- QR Scanner -->
    <div class="flex justify-center">
      <div id="reader" class="border rounded bg-gray-50" style="width:100%;max-width:400px;height:300px;"></div>
    </div>

    <!-- Status -->
    <div id="status" class="mt-4 text-sm text-center"></div>

    <!-- HR Export -->
    <div class="mt-6 text-center">
      <button id="exportBtn" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
        Download Attendance Report (CSV)
      </button>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);
    const API = (path) => path; // relative to FastAPI

    async function loadOptions() {
      try {
        const depts = await fetch(API('/api/departments')).then(r=>r.json());
        const locs = await fetch(API('/api/locations')).then(r=>r.json());
        $('department').innerHTML = depts.map(d=>`<option value="${d.id}">${d.name}</option>`).join('');
        $('location').innerHTML = locs.map(l=>`<option value="${l.id}">${l.name}</option>`).join('');
      } catch (err) {
        $('status').innerHTML = "⚠️ Failed to load departments/locations";
      }
    }

    function show(msg, ok=true) {
      $('status').innerHTML = `<div class="p-2 rounded ${ok?'bg-green-100 text-green-800':'bg-red-100 text-red-800'}">${msg}</div>`;
    }

    async function postPunch(qrValue){
      const payload = {
        qr_code_value: qrValue,
        action: $('action').value,
        m_number: $('mnumber').value || null,
        location_id: parseInt($('location').value),
        department_id: parseInt($('department').value),
        device_label: navigator.userAgent
      };
      const res = await fetch(API('/api/punch'), {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify(payload)
      });
      if(!res.ok){ throw new Error((await res.json()).detail || 'Punch failed'); }
      return res.json();
    }

    let qr;
    $('startBtn').onclick = async () => {
      if(qr){
        try { await qr.stop(); } catch (e) { console.warn("Stop error:", e); }
      }
      qr = new Html5Qrcode("reader");
      qr.start(
        { facingMode: "environment" }, 
        { fps: 10, qrbox: 250 },
        async (decodedText) => {
          try {
            const r = await postPunch(decodedText.trim());
            if (qr) { try { await qr.stop(); } catch (e) { console.warn("Stop error:", e); } }
            show(`✅ ${r.employee}: ${r.action.toUpperCase()} at ${new Date(r.ts).toLocaleString()}`);
          } catch (err) {
            show("❌ " + err.message, false);
          }
        },
        (err) => {}
      ).catch(e=>show("Camera start failed: " + e, false));
    };

    $('stopBtn').onclick = async () => {
      if(qr){
        try { await qr.stop(); show("⏹️ Scanner stopped", false); }
        catch (e) { console.warn("Stop error:", e); show("⚠️ Scanner already stopped", false); }
      }
    };

    $('exportBtn').onclick = () => { window.location.href = API('/api/export'); };
    loadOptions();
  </script>
</body>
</html>
